# ============================================================================
# Nginx Configuration for HREM (HR Employee Management)
# Frontend: React + Vite (built static files)
# Backend:  Laravel API (PHP-FPM)
# ============================================================================

server {
    # ── 1. Listener ──────────────────────────────────────────────────────────
    listen       80;
    server_name  hrem.local;          # Change to your domain in production
    charset      utf-8;

    # ── 2. Logging ───────────────────────────────────────────────────────────
    access_log  /var/log/nginx/hrem_access.log;
    error_log   /var/log/nginx/hrem_error.log;

    # ── 3. Max upload size (matches Laravel's upload limits) ─────────────────
    client_max_body_size 20M;

    # ── 4. Root — points to the React production build ──────────────────────
    root /var/www/hrem/client/dist;
    index index.html;

    # ── 5. Frontend — serve the React SPA ────────────────────────────────────
    # Any request that is NOT /api/* or /sanctum/* is handled here.
    # try_files first checks if the URI matches a real file (JS, CSS, images),
    # if not it falls back to index.html so React Router can handle the route.
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ── 6. Static assets caching ─────────────────────────────────────────────
    # Vite adds content-hashes to filenames, so long cache is safe.
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # ── 7. Backend API — proxy to Laravel (PHP-FPM) ──────────────────────────
    # Every request starting with /api/ is forwarded to the Laravel backend.
    location /api/ {
        alias /var/www/hrem/server/public/;
        try_files $uri $uri/ @laravel;

        # Process .php files through PHP-FPM
        location ~ \.php$ {
            fastcgi_pass  unix:/run/php/php8.2-fpm.sock;   # Adjust PHP version
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include       fastcgi_params;
        }
    }

    # ── 8. Sanctum CSRF cookie endpoint ──────────────────────────────────────
    # Laravel Sanctum's SPA auth requires this route to set the XSRF cookie.
    location /sanctum/ {
        alias /var/www/hrem/server/public/;
        try_files $uri $uri/ @laravel;

        location ~ \.php$ {
            fastcgi_pass  unix:/run/php/php8.2-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include       fastcgi_params;
        }
    }

    # ── 9. Laravel fallback — rewrite to index.php ───────────────────────────
    # Named location used by try_files when no static file is found under
    # /api or /sanctum. Rewrites everything to Laravel's front controller.
    location @laravel {
        rewrite ^(.*)$ /index.php$1 last;
    }

    # ── 10. Laravel front controller ─────────────────────────────────────────
    # The main PHP entry point for all Laravel requests.
    location ~ ^/index\.php$ {
        root          /var/www/hrem/server/public;
        fastcgi_pass  unix:/run/php/php8.2-fpm.sock;       # Adjust PHP version
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include       fastcgi_params;

        # Pass original request info to PHP
        fastcgi_param HTTP_HOST       $host;
        fastcgi_param REQUEST_URI     $request_uri;
        fastcgi_param QUERY_STRING    $query_string;

        # Timeouts for slow PHP scripts
        fastcgi_read_timeout  300;
        fastcgi_send_timeout  300;
    }

    # ── 11. Security — deny hidden files ─────────────────────────────────────
    # Block access to .env, .git, .htaccess, etc.
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ── 12. Deny direct PHP execution in client files ────────────────────────
    # Prevents running PHP files from the frontend directory.
    location ~* \.php$ {
        return 404;
    }
}
